# Процесс создания релиза ARC

Это руководство описывает полный процесс создания и публикации нового релиза приложения ARC.

## Содержание

1. [Подготовка к релизу](#подготовка-к-релизу)
2. [Локальная сборка и тестирование](#локальная-сборка-и-тестирование)
3. [Публикация релиза через GitHub](#публикация-релиза-через-github)
4. [Ручная публикация (без GitHub Actions)](#ручная-публикация-без-github-actions)
5. [Проверка автообновлений](#проверка-автообновлений)
6. [Откат релиза](#откат-релиза)

---

## Подготовка к релизу

### 1. Убедитесь, что все изменения закоммичены

```bash
git status
# Должно быть: working tree clean
```

### 2. Обновите версию в package.json

Выберите тип версионирования согласно [Semantic Versioning](https://semver.org/):

- **MAJOR** (X.0.0): несовместимые изменения API
- **MINOR** (0.X.0): новая функциональность (обратно совместимая)
- **PATCH** (0.0.X): исправления багов

**Автоматически (рекомендуется):**

```bash
# Для patch (1.0.0 -> 1.0.1)
npm version patch

# Для minor (1.0.1 -> 1.1.0)
npm version minor

# Для major (1.1.0 -> 2.0.0)
npm version major
```

Команда `npm version` автоматически:
- Обновит версию в `package.json`
- Создаст git commit с сообщением "v1.0.1"
- Создаст git tag "v1.0.1"

**Вручную:**

Отредактируйте `package.json`:

```json
{
  "version": "1.0.1"
}
```

Затем создайте commit и tag вручную:

```bash
git add package.json
git commit -m "Bump version to 1.0.1"
git tag v1.0.1
```

### 3. Подготовьте CHANGELOG (опционально)

Создайте или обновите файл `CHANGELOG.md` с описанием изменений:

```markdown
# Changelog

## [1.0.1] - 2025-11-13

### Added
- Новая функция поиска по меткам

### Fixed
- Исправлена ошибка при импорте больших изображений
- Улучшена производительность галереи

### Changed
- Обновлен дизайн карточек коллекций
```

---

## Локальная сборка и тестирование

### 1. Установите зависимости (если нужно)

```bash
npm ci
cd renderer && npm ci && cd ..
```

### 2. Соберите приложение локально

**Без подписи (для тестирования):**

```bash
npm run build:prod
```

**С подписью (если настроен сертификат):**

```bash
# Убедитесь, что установлены переменные окружения
# CSC_LINK и CSC_KEY_PASSWORD
npm run build:prod:signed
```

### 3. Найдите собранный установщик

Результат сборки будет в папке `release/`:

```
release/
  ├── ARC-Setup-1.0.1.exe     # Установщик
  ├── latest.yml              # Метаданные для автообновлений
  └── win-unpacked/           # Распакованное приложение (для тестирования)
```

### 4. Протестируйте установщик

1. **Запустите установщик** на чистой машине или виртуалке
2. **Проверьте установку:**
   - Выбор папки установки работает?
   - Создается ярлык на рабочем столе?
   - Создается ярлык в меню Пуск?
   - Приложение запускается?

3. **Проверьте функциональность:**
   - Все основные функции работают?
   - База данных создается корректно?
   - Импорт файлов работает?

4. **Проверьте деинсталляцию:**
   - Откройте "Установка и удаление программ"
   - Найдите "ARC" в списке
   - Нажмите "Удалить"
   - Убедитесь, что приложение удаляется корректно
   - База данных должна сохраниться в `%APPDATA%/ARC/`

---

## Публикация релиза через GitHub

### Автоматическая публикация (рекомендуется)

GitHub Actions автоматически соберет и опубликует релиз при push тега.

**1. Отправьте tag в GitHub:**

```bash
git push origin main
git push origin v1.0.1
```

**2. Дождитесь завершения сборки:**

- Откройте https://github.com/rocontd/arc/actions
- Найдите workflow "Build and Release"
- Дождитесь успешного завершения (зеленая галочка)

**3. Проверьте релиз:**

- Откройте https://github.com/rocontd/arc/releases
- Найдите релиз "v1.0.1"
- Убедитесь, что прикреплены файлы:
  - `ARC-Setup-1.0.1.exe`
  - `latest.yml`

**4. Добавьте описание релиза (опционально):**

- Нажмите "Edit" на странице релиза
- Добавьте Release Notes из CHANGELOG
- Нажмите "Update release"

### Настройка GitHub Actions (первый раз)

Если это первый релиз, убедитесь, что настроены GitHub Secrets:

1. Откройте **Settings** → **Secrets and variables** → **Actions**
2. Проверьте наличие secrets (если используете code signing):
   - `WINDOWS_CERTIFICATE` - Base64 сертификата
   - `WINDOWS_CERTIFICATE_PASSWORD` - Пароль сертификата
3. `GITHUB_TOKEN` добавляется автоматически (не нужно настраивать)

Подробнее см. [docs/code-signing.md](./code-signing.md)

---

## Ручная публикация (без GitHub Actions)

Если GitHub Actions недоступен или вы хотите опубликовать вручную:

**1. Соберите приложение локально:**

```bash
npm run build:prod:signed
```

**2. Создайте релиз на GitHub вручную:**

- Откройте https://github.com/rocontd/arc/releases/new
- **Tag**: v1.0.1
- **Release title**: ARC v1.0.1
- **Description**: Добавьте Release Notes
- **Attach files**: Перетащите файлы:
  - `release/ARC-Setup-1.0.1.exe`
  - `release/latest.yml` (⚠️ ОБЯЗАТЕЛЬНО для автообновлений!)

**3. Нажмите "Publish release"**

---

## Проверка автообновлений

После публикации релиза проверьте систему автообновлений:

### 1. Установите предыдущую версию

Установите версию 1.0.0 (или любую предыдущую) на тестовую машину.

### 2. Запустите приложение

Приложение проверит обновления автоматически:
- При запуске (через 3 секунды)
- Каждые 4 часа

### 3. Дождитесь уведомления

Должно появиться уведомление о доступном обновлении:
- "Доступна новая версия ARC!"
- Кнопка "Обновить"

### 4. Загрузите обновление

Нажмите "Обновить" и дождитесь загрузки.

### 5. Перезапустите приложение

- Приложение предложит перезапуск
- После перезапуска должна установиться новая версия
- Проверьте версию в "Настройки" → "О программе"

### 6. Проверьте сохранность данных

- Все карточки, теги, коллекции должны остаться
- База данных не должна пострадать
- Настройки должны сохраниться

---

## Откат релиза

Если обнаружены критические баги после публикации:

### Вариант 1: Пометить как Pre-release

1. Откройте страницу релиза на GitHub
2. Нажмите "Edit"
3. Установите галочку "Set as a pre-release"
4. Нажмите "Update release"

Пользователи не получат это обновление автоматически.

### Вариант 2: Удалить релиз

⚠️ **Используйте с осторожностью!**

1. Откройте страницу релиза на GitHub
2. Нажмите "Delete"
3. Подтвердите удаление

**Также удалите tag:**

```bash
# Локально
git tag -d v1.0.1

# На GitHub
git push origin :refs/tags/v1.0.1
```

### Вариант 3: Выпустить hotfix

Быстро выпустите исправленную версию:

```bash
# Исправьте баг в коде
git add .
git commit -m "Fix critical bug"

# Bump версию
npm version patch  # 1.0.1 -> 1.0.2

# Опубликуйте
git push origin main
git push origin v1.0.2
```

---

## Частые вопросы

### Как изменить версию, если уже создал tag?

```bash
# Удалите tag локально
git tag -d v1.0.1

# Удалите на GitHub
git push origin :refs/tags/v1.0.1

# Обновите версию в package.json
npm version 1.0.2

# Создайте новый tag
git push origin main
git push origin v1.0.2
```

### Что делать, если GitHub Actions упал?

1. Проверьте логи в Actions
2. Исправьте ошибку в коде
3. Удалите старый tag и создайте новый:

```bash
git tag -d v1.0.1
git push origin :refs/tags/v1.0.1
npm version patch
git push origin main
git push origin v1.0.2
```

### Можно ли выпустить релиз с веткой, отличной от main?

Да, но не рекомендуется. GitHub Actions настроен на любой tag, независимо от ветки.

```bash
git checkout feature-branch
npm version patch
git push origin feature-branch
git push origin v1.0.1-beta
```

### Как выпустить beta-версию?

```bash
# Установите версию с beta-суффиксом
npm version 1.1.0-beta.1

# Push tag
git push origin main
git push origin v1.1.0-beta.1

# На GitHub пометьте релиз как "Pre-release"
```

### Где хранится база данных при обновлениях?

База данных (IndexedDB) хранится в:

```
%APPDATA%\ARC\
```

Эта папка не удаляется при обновлениях или деинсталляции (если не установлен флаг `deleteAppDataOnUninstall: true`).

---

## Чеклист релиза

Используйте этот чеклист перед каждым релизом:

- [ ] Все изменения закоммичены
- [ ] Пройдены все тесты
- [ ] Обновлен CHANGELOG.md (если есть)
- [ ] Обновлена версия в package.json
- [ ] Создан git tag (vX.X.X)
- [ ] Tag отправлен в GitHub
- [ ] GitHub Actions успешно завершен (если используется)
- [ ] Релиз опубликован на GitHub
- [ ] Прикреплены файлы ARC-Setup-X.X.X.exe и latest.yml
- [ ] Добавлено описание релиза
- [ ] Протестирован установщик
- [ ] Проверено автообновление
- [ ] Проверена сохранность данных после обновления

---

## Полезные команды

```bash
# Проверить текущую версию
npm version

# Показать все tags
git tag -l

# Показать информацию о последнем tag
git describe --tags

# Удалить tag локально
git tag -d v1.0.1

# Удалить tag на GitHub
git push origin :refs/tags/v1.0.1

# Посмотреть последние релизы
git log --oneline --decorate

# Собрать без подписи
npm run build:prod

# Собрать с подписью
npm run build:prod:signed

# Упаковать без создания установщика (для тестирования)
npm run pack
```

---

## Дополнительные ресурсы

- [Semantic Versioning](https://semver.org/)
- [GitHub Releases](https://docs.github.com/en/repositories/releasing-projects-on-github)
- [electron-builder Documentation](https://www.electron.build/)
- [Code Signing Guide](./code-signing.md)


