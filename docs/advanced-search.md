# Расширенный поиск в ARC

## Обзор

Расширенный поиск предоставляет мощные инструменты для поиска карточек по меткам, категориям и истории поиска.

## Компоненты

### SearchBar
**Расположение:** `renderer/src/components/layout/SearchBar.tsx`

Основной компонент поиска с полем ввода и отображением выбранных меток.

**Функционал:**
- Поле ввода с автодополнением
- Отображение выбранных меток с возможностью удаления
- Кнопка "Очистить всё" для сброса всех фильтров
- Открытие выпадающего меню при фокусе или вводе

**Props:**
- `value` - текущий поисковый запрос
- `onChange` - обработчик изменения запроса
- `selectedTags` - массив ID выбранных меток
- `onTagsChange` - обработчик изменения выбранных меток

### SearchDropdown
**Расположение:** `renderer/src/components/layout/SearchDropdown.tsx`

Выпадающее меню с категориями, метками и историей поиска.

**Функционал:**
- **История поиска** - последние 5 запросов с возможностью повторного использования
- **Категории** - список всех категорий с количеством меток в каждой
- **Метки** - фильтруемый список меток с информацией о категории и количестве карточек
- **Автодополнение** - динамическая фильтрация по вводимому тексту
- **Фильтрация по категориям** - клик по категории показывает только её метки

**Props:**
- `searchQuery` - текущий поисковый запрос для фильтрации
- `selectedTags` - массив ID выбранных меток
- `onTagSelect` - обработчик выбора/снятия метки
- `onHistorySelect` - обработчик выбора записи из истории
- `isVisible` - флаг видимости выпадающего меню

## Алгоритм работы

### 1. Поиск по меткам и категориям

При вводе текста в поле поиска происходит:

```typescript
// Фильтрация меток по названию (включает подстроку)
const filteredTags = tags.filter(tag => 
  tag.name.toLowerCase().includes(query.toLowerCase())
);

// Фильтрация категорий по названию
const filteredCategories = categories.filter(cat =>
  cat.name.toLowerCase().includes(query.toLowerCase())
);
```

Результаты сортируются по популярности (количеству карточек).

### 2. История поиска

История сохраняется автоматически при:
- Выборе метки из выпадающего меню
- Нажатии "Очистить всё" (если были выбранные метки)

```typescript
// Сохранение в историю
await addSearchHistory(searchQuery, selectedTagIds);
```

История хранится в IndexedDB и ограничена 15 последними записями.

### 3. Фильтрация по категориям

Клик по категории в выпадающем меню:
- **Первый клик** - фильтрует метки, показывая только метки выбранной категории
- **Повторный клик** - сбрасывает фильтр, показывая все метки

### 4. Выбор меток

Клик по метке в выпадающем меню:
- **Если метка не выбрана** - добавляет её к выбранным и сохраняет в историю
- **Если метка уже выбрана** - убирает её из выбранных

## Интеграция с поиском карточек

Выбранные метки передаются в функцию `searchCardsAdvanced`:

```typescript
// renderer/src/services/db.ts
export async function searchCardsAdvanced(query: string): Promise<Card[]>
```

**Логика поиска:**
1. Поиск по точному совпадению ID карточки
2. Поиск карточек с метками, соответствующими запросу
3. Поиск карточек по категориям, соответствующим запросу

## Использование

### Базовый поиск по тексту

1. Введите название метки или категории в поле поиска
2. Выберите подходящую метку из выпадающего списка
3. Карточки автоматически отфильтруются

### Поиск по нескольким меткам

1. Выберите первую метку
2. Не закрывая выпадающее меню, выберите дополнительные метки
3. Будут показаны только карточки, содержащие ВСЕ выбранные метки (логика AND)

### Использование истории

1. Кликните в поле поиска без ввода текста
2. В разделе "История поиска" выберите нужную запись
3. Поисковый запрос и метки восстановятся автоматически

### Фильтрация по категории

1. В выпадающем меню выберите категорию
2. Список меток будет отфильтрован
3. Для сброса фильтра нажмите "Сбросить фильтр" или кликните по категории повторно

## Клавиатурные сокращения

- `Esc` - закрыть выпадающее меню
- Клик вне компонента - закрыть выпадающее меню

## Производительность

### Оптимизации

1. **Debounce поиска** - 300мс задержка при вводе текста (реализовано в `CardsPage`)
2. **Ленивая загрузка** - данные для выпадающего меню загружаются только при открытии
3. **Мемоизация** - фильтрация меток и категорий кешируется через `useMemo`
4. **Ограничение результатов** - максимум 20 меток в выпадающем меню

### Размер истории

- Максимум 15 записей в истории поиска
- Максимум 15 записей в истории просмотров
- Автоматическая очистка старых записей

## Стилизация

Стили находятся в:
- `renderer/src/components/layout/SearchBar.css`
- `renderer/src/components/layout/SearchDropdown.css`

**Дизайн-система:**
- Использует CSS переменные из `renderer/src/styles/variables.css`
- Адаптивные размеры для разных разрешений экрана
- Плавные анимации появления/скрытия (transition-fast)
- Кастомный скроллбар для длинных списков

## База данных

### Таблицы

**searchHistory**
```typescript
interface SearchHistory {
  id: string;           // Уникальный ID
  query: string;        // Поисковый запрос
  timestamp: Date;      // Время запроса
  tagIds: string[];     // ID выбранных меток
}
```

**Индексы:**
- `id` - первичный ключ
- `timestamp` - для сортировки по времени
- `tagIds` - мультиключевой индекс

### API функции

```typescript
// Добавление записи в историю (автоматическая очистка старых)
await addSearchHistory(query: string, tagIds: string[]): Promise<void>

// Получение истории (последние 15 записей)
await getSearchHistory(): Promise<SearchHistory[]>

// Поиск карточек
await searchCardsAdvanced(query: string): Promise<Card[]>
```

## Будущие улучшения

### Возможные дополнения

1. **Горячие клавиши**
   - `Ctrl+F` - фокус на поле поиска
   - `↑/↓` - навигация по результатам
   - `Enter` - выбор метки

2. **Сохраненные фильтры**
   - Возможность сохранить набор меток как "избранный фильтр"
   - Быстрый доступ к часто используемым комбинациям

3. **Умный поиск**
   - Поиск по синонимам
   - Поиск по цвету карточки
   - Поиск по дате добавления

4. **Экспорт результатов**
   - Сохранение результатов поиска как коллекцию
   - Экспорт списка ID найденных карточек

## Тестирование

### Сценарии тестирования

1. **Базовый поиск**
   - ✅ Ввод текста открывает выпадающее меню
   - ✅ Фильтрация меток по введенному тексту
   - ✅ Выбор метки добавляет её к выбранным

2. **Множественный выбор**
   - ✅ Выбор нескольких меток одновременно
   - ✅ Удаление отдельной метки
   - ✅ Очистка всех меток

3. **История**
   - ✅ Сохранение истории при выборе метки
   - ✅ Восстановление поиска из истории
   - ✅ Ограничение размера истории (15 записей)

4. **Категории**
   - ✅ Фильтрация меток по категории
   - ✅ Сброс фильтра категории
   - ✅ Подсчет количества меток в категории

5. **UI/UX**
   - ✅ Закрытие при клике вне компонента
   - ✅ Плавная анимация открытия/закрытия
   - ✅ Корректное отображение на разных разрешениях

## Известные ограничения

1. **Лимит результатов** - максимум 20 меток в выпадающем меню (для производительности)
2. **Логика AND** - множественный выбор меток работает только с логикой AND (все метки должны присутствовать)
3. **Нет поиска по содержимому** - поиск работает только по меткам, категориям и ID

## Поддержка

При возникновении проблем или вопросов обращайтесь к основной документации проекта:
- `docs/development.md` - руководство разработчика
- `docs/technical.md` - техническая документация
- `DEVELOPMENT_WORKFLOW.md` - workflow разработки

